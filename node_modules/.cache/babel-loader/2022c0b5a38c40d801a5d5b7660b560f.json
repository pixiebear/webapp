{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\n\nvar errors_1 = require(\"@ledgerhq/errors\");\n\nvar Tag = 0x05;\n\nfunction asUInt16BE(value) {\n  var b = Buffer.alloc(2);\n  b.writeUInt16BE(value, 0);\n  return b;\n}\n\nvar initialAcc = {\n  data: Buffer.alloc(0),\n  dataLength: 0,\n  sequence: 0\n};\n/**\n *\n */\n\nvar createHIDframing = function (channel, packetSize) {\n  return {\n    makeBlocks: function (apdu) {\n      var data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n      var blockSize = packetSize - 5;\n      var nbBlocks = Math.ceil(data.length / blockSize);\n      data = Buffer.concat([data, Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0)]);\n      var blocks = [];\n\n      for (var i = 0; i < nbBlocks; i++) {\n        var head = Buffer.alloc(5);\n        head.writeUInt16BE(channel, 0);\n        head.writeUInt8(Tag, 2);\n        head.writeUInt16BE(i, 3);\n        var chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n        blocks.push(Buffer.concat([head, chunk]));\n      }\n\n      return blocks;\n    },\n    reduceResponse: function (acc, chunk) {\n      var _a = acc || initialAcc,\n          data = _a.data,\n          dataLength = _a.dataLength,\n          sequence = _a.sequence;\n\n      if (chunk.readUInt16BE(0) !== channel) {\n        throw new errors_1.TransportError(\"Invalid channel\", \"InvalidChannel\");\n      }\n\n      if (chunk.readUInt8(2) !== Tag) {\n        throw new errors_1.TransportError(\"Invalid tag\", \"InvalidTag\");\n      }\n\n      if (chunk.readUInt16BE(3) !== sequence) {\n        throw new errors_1.TransportError(\"Invalid sequence\", \"InvalidSequence\");\n      }\n\n      if (!acc) {\n        dataLength = chunk.readUInt16BE(5);\n      }\n\n      sequence++;\n      var chunkData = chunk.slice(acc ? 5 : 7);\n      data = Buffer.concat([data, chunkData]);\n\n      if (data.length > dataLength) {\n        data = data.slice(0, dataLength);\n      }\n\n      return {\n        data: data,\n        dataLength: dataLength,\n        sequence: sequence\n      };\n    },\n    getReducedResult: function (acc) {\n      if (acc && acc.dataLength === acc.data.length) {\n        return acc.data;\n      }\n    }\n  };\n};\n\nexports[\"default\"] = createHIDframing;","map":{"version":3,"sources":["../src/hid-framing.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nexports.__esModule = true;\nvar errors_1 = require(\"@ledgerhq/errors\");\nvar Tag = 0x05;\nfunction asUInt16BE(value) {\n    var b = Buffer.alloc(2);\n    b.writeUInt16BE(value, 0);\n    return b;\n}\nvar initialAcc = {\n    data: Buffer.alloc(0),\n    dataLength: 0,\n    sequence: 0\n};\n/**\n *\n */\nvar createHIDframing = function (channel, packetSize) {\n    return {\n        makeBlocks: function (apdu) {\n            var data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n            var blockSize = packetSize - 5;\n            var nbBlocks = Math.ceil(data.length / blockSize);\n            data = Buffer.concat([\n                data,\n                Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0),\n            ]);\n            var blocks = [];\n            for (var i = 0; i < nbBlocks; i++) {\n                var head = Buffer.alloc(5);\n                head.writeUInt16BE(channel, 0);\n                head.writeUInt8(Tag, 2);\n                head.writeUInt16BE(i, 3);\n                var chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n                blocks.push(Buffer.concat([head, chunk]));\n            }\n            return blocks;\n        },\n        reduceResponse: function (acc, chunk) {\n            var _a = acc || initialAcc, data = _a.data, dataLength = _a.dataLength, sequence = _a.sequence;\n            if (chunk.readUInt16BE(0) !== channel) {\n                throw new errors_1.TransportError(\"Invalid channel\", \"InvalidChannel\");\n            }\n            if (chunk.readUInt8(2) !== Tag) {\n                throw new errors_1.TransportError(\"Invalid tag\", \"InvalidTag\");\n            }\n            if (chunk.readUInt16BE(3) !== sequence) {\n                throw new errors_1.TransportError(\"Invalid sequence\", \"InvalidSequence\");\n            }\n            if (!acc) {\n                dataLength = chunk.readUInt16BE(5);\n            }\n            sequence++;\n            var chunkData = chunk.slice(acc ? 5 : 7);\n            data = Buffer.concat([data, chunkData]);\n            if (data.length > dataLength) {\n                data = data.slice(0, dataLength);\n            }\n            return {\n                data: data,\n                dataLength: dataLength,\n                sequence: sequence\n            };\n        },\n        getReducedResult: function (acc) {\n            if (acc && acc.dataLength === acc.data.length) {\n                return acc.data;\n            }\n        }\n    };\n};\nexports[\"default\"] = createHIDframing;\n//# sourceMappingURL=hid-framing.js.map"]},"metadata":{},"sourceType":"script"}